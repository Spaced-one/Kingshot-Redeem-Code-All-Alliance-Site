<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingshot - Gift Code Tool</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Apply gift codes to multiple Kingshot player IDs easily. Manage lists, track results, and automate code redemption for your alliance.">
    <meta name="keywords" content="Kingshot, gift code, redeem code, alliance tool, batch redeem">
    <meta name="author" content="Kingshot Community">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://spaced-one.github.io/KingshotRedeemCodeAllAllianceSite/">
    <meta property="og:title" content="Kingshot - Gift Code Tool">
    <meta property="og:description" content="Apply gift codes to multiple Kingshot player IDs easily. Manage lists, track results, and automate code redemption for your alliance.">
    <meta property="og:image" content="https://spaced-one.github.io/KingshotRedeemCodeAllAllianceSite/preview.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="Kingshot Gift Code Tool">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://spaced-one.github.io/KingshotRedeemCodeAllAllianceSite/">
    <meta name="twitter:title" content="Kingshot - Gift Code Tool">
    <meta name="twitter:description" content="Apply gift codes to multiple Kingshot player IDs easily. Manage lists, track results, and automate code redemption for your alliance.">
    <meta name="twitter:image" content="https://spaced-one.github.io/KingshotRedeemCodeAllAllianceSite/preview.png">
    
    <!-- Discord Embed Color -->
    <meta name="theme-color" content="#6366f1">
    
    <style>
        :root {
            --bg: #0f172a;
            --bg-soft: #0b1224;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --card: #0b1224;
            --border: #1f2942;
            --primary: #6366f1;
            --primary-600: #5458ee;
            --success: #22c55e;
            --error: #ef4444;
            --info: #38bdf8;
            --shadow: 0 10px 30px rgba(0,0,0,.25);
        }
        [data-theme="light"] {
            --bg: #f3f4f6;
            --bg-soft: #eef2ff;
            --text: #0f172a;
            --muted: #475569;
            --card: #ffffff;
            --border: #e5e7eb;
            --primary: #4f46e5;
            --primary-600: #4338ca;
            --success: #16a34a;
            --error: #dc2626;
            --info: #0ea5e9;
            --shadow: 0 8px 24px rgba(2,6,23,.12);
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            margin: 0;
            color: var(--text);
            background: radial-gradient(1000px 500px at 20% -10%, rgba(99,102,241,.15), transparent 50%),
                        radial-gradient(800px 400px at 110% 0%, rgba(56,189,248,.12), transparent 40%),
                        var(--bg);
            padding: 0 16px 40px;
        }

        .app-header {
            max-width: 900px;
            margin: 28px auto 16px;
            background: linear-gradient(135deg, rgba(99,102,241,.2), rgba(56,189,248,.2));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .title-wrap { display: flex; gap: 12px; align-items: center; }
        .logo {
            width: 36px; height: 36px; border-radius: 10px; display: grid; place-items: center;
            background: linear-gradient(135deg, var(--primary), #22c55e);
            color: white; box-shadow: 0 6px 20px rgba(99,102,241,.35);
        }
        .title { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: .2px; }
        .subtitle { margin: 0; font-size: 13px; color: var(--muted); }

        .theme-toggle {
            appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--text);
            padding: 8px 12px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
            transition: background .2s ease, transform .05s ease; box-shadow: var(--shadow);
        }
        .theme-toggle:hover { background: var(--bg-soft); }
        .theme-toggle:active { transform: translateY(1px); }

        .container {
            max-width: 900px;
            margin: 0 auto;
            display: grid;
            gap: 20px;
        }

        .section-card {
            background: var(--card);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .section-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 20px;
        }

        .section-header-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .section-number {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), #22c55e);
            color: white;
            display: grid;
            place-items: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(99,102,241,.3);
        }

        .section-number-sm {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--primary), #22c55e);
            color: white;
            display: grid;
            place-items: center;
            font-weight: 700;
            font-size: 13px;
            flex-shrink: 0;
        }

        .section-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .section-hint {
            margin: 4px 0 0 0;
            font-size: 13px;
            color: var(--muted);
            line-height: 1.4;
        }

        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 24px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .form-label-inline {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            margin: 0;
        }

        .field-info {
            color: var(--muted);
            font-size: 12px;
            margin-top: 6px;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: linear-gradient(0deg, var(--bg) 0%, var(--card) 100%);
            color: var(--text);
            outline: none;
            transition: border-color .2s ease, box-shadow .2s ease;
            font-size: 14px;
        }

        .form-textarea {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            resize: vertical;
        }

        .form-input:focus, .form-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99,102,241,.25);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .button-group-sm {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .status-message {
            min-height: 20px;
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: var(--bg);
            color: var(--muted);
            border: 1px solid var(--border);
        }

        .info-panel {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            margin-top: 16px;
        }

        .info-panel-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-grid {
            display: grid;
            gap: 10px;
        }

        .advanced-options {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            margin: 16px 0;
        }

        .advanced-options-summary {
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
            user-select: none;
            list-style: none;
        }

        .advanced-options-summary::-webkit-details-marker {
            display: none;
        }

        .advanced-options-content {
            padding-top: 12px;
        }

        form label { font-weight: 600; font-size: 14px; }
        .field { margin-top: 14px; }
        .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }

        textarea, input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            margin-top: 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: linear-gradient(0deg, var(--bg) 0%, var(--card) 100%);
            color: var(--text);
            outline: none;
            transition: border-color .2s ease, box-shadow .2s ease;
        }
        textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; resize: vertical; }
        textarea:focus, input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(99,102,241,.25); }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: transform .05s ease, filter .2s ease, background .2s ease;
            white-space: nowrap;
        }

        .btn:active { transform: translateY(1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-600));
            color: #fff;
            box-shadow: 0 8px 22px rgba(79,70,229,.35);
        }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.05); }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(99,102,241,.1), rgba(56,189,248,.08));
            color: var(--text);
            border: 1px solid var(--primary);
            border-color: rgba(99,102,241,.3);
            box-shadow: 0 2px 8px rgba(0,0,0,.08);
        }
        .btn-secondary:hover:not(:disabled) { 
            background: linear-gradient(135deg, rgba(99,102,241,.15), rgba(56,189,248,.12));
            border-color: rgba(99,102,241,.5);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            border: 1px solid #dc2626;
        }
        .btn-danger:hover:not(:disabled) { filter: brightness(1.05); }

        .btn-large {
            width: 100%;
            padding: 16px 24px;
            font-size: 16px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 8px;
            font-weight: 600;
            background: linear-gradient(135deg, rgba(99,102,241,.12), rgba(56,189,248,.1));
            border: 1px solid rgba(99,102,241,.35);
        }

        .btn-sm.btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(99,102,241,.18), rgba(56,189,248,.15));
            border-color: rgba(99,102,241,.5);
        }

        .btn-sm.btn-danger {
            background: linear-gradient(135deg, rgba(239,68,68,.15), rgba(220,38,38,.12));
            color: #ef4444;
            border: 1px solid rgba(239,68,68,.4);
        }

        .btn-sm.btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(239,68,68,.2), rgba(220,38,38,.18));
            border-color: rgba(239,68,68,.6);
            color: #dc2626;
        }

        .row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 14px; }

        .muted { color: var(--muted); font-size: 12px; margin-top: 6px; }

        .message {
            padding: 14px;
            margin-top: 18px;
            background: linear-gradient(0deg, var(--bg) 0%, var(--card) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-height: 340px;
            overflow: auto;
        }
        .status-success { color: var(--success); }
        .status-error { color: var(--error); }
        .status-info { color: var(--info); }
        .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); }
        .pill.success { background: rgba(34,197,94,.12); color: var(--success); border-color: rgba(34,197,94,.35); }
        .pill.error { background: rgba(239,68,68,.12); color: var(--error); border-color: rgba(239,68,68,.35); }
        .pill.info { background: rgba(56,189,248,.12); color: var(--info); border-color: rgba(56,189,248,.35); }

        .hidden { display: none; }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.8); border-top-color: transparent; border-radius: 50%; display: inline-block; vertical-align: middle; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    <script>window.tailwind = window.tailwind || {}; window.tailwind.config = { darkMode: 'class' };</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CryptoJS pour MD5 (m√™me lib que l‚Äôoriginal) -->
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
</head>
<body>

<div class="app-header">
    <div class="title-wrap">
        <div class="logo" aria-hidden="true">üéÅ</div>
        <div>
            <h1 class="title" id="app-title">Codes cadeaux</h1>
            <p class="subtitle" id="subtitle">Collez vos IDs (un par ligne) et appliquez un code cadeau √† la vol√©e.</p>
        </div>
    </div>
    <button class="theme-toggle" type="button" id="theme-toggle" aria-label="Basculer le th√®me">
        <span id="theme-icon">üåô</span>
                <span id="theme-label" style="font-size:12px">Th√®me</span>
    </button>
</div>

<div class="container">
    <!-- SECTION 1: Gestion des listes sauvegard√©es -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-number">1</div>
            <div>
                <h2 class="section-title" id="section-lists-title">Mes listes d'IDs</h2>
                <p class="section-hint" id="section-lists-hint">Cr√©ez et g√©rez vos listes d'IDs pour les r√©utiliser facilement</p>
            </div>
        </div>
        
        <div class="form-group">
            <label for="list-select" id="lists-label" class="form-label">Liste active</label>
            <select id="list-select" class="form-input"></select>
        </div>

        <div class="button-group">
            <button type="button" id="list-load" class="btn btn-primary">
                <span>üì•</span>
                <span id="btn-list-load-text">Charger dans le champ</span>
            </button>
            <button type="button" id="list-save" class="btn btn-secondary">
                <span>üíæ</span>
                <span id="btn-list-save-text">Sauvegarder le champ</span>
            </button>
        </div>

        <div class="button-group-sm">
            <button type="button" id="list-new" class="btn-sm btn-secondary">
                <span id="btn-list-new-text">+ Nouvelle</span>
            </button>
            <button type="button" id="list-rename" class="btn-sm btn-secondary">
                <span id="btn-list-rename-text">‚úèÔ∏è Renommer</span>
            </button>
            <button type="button" id="list-delete" class="btn-sm btn-danger">
                <span id="btn-list-delete-text">üóëÔ∏è Supprimer</span>
            </button>
            <button type="button" id="list-infos" class="btn-sm btn-secondary">
                <span id="btn-list-infos-text">‚ÑπÔ∏è Infos joueurs</span>
            </button>
        </div>

        <div id="list-status" class="status-message"></div>

        <div id="list-infos-view" class="hidden info-panel">
            <div id="label-infos-title" class="info-panel-title">Infos utilisateurs</div>
            <div id="infos" class="info-grid"></div>
        </div>
    </div>

    <!-- SECTION 2: Saisie des IDs -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-number">2</div>
            <div>
                <h2 class="section-title" id="section-ids-title">Liste des IDs joueurs</h2>
                <p class="section-hint" id="section-ids-hint">Collez les IDs (un par ligne, ou s√©par√©s par des virgules)</p>
            </div>
        </div>

        <form id="giftcode-form">
            <div class="form-group">
                <label for="ids" id="label-ids" class="form-label">IDs √† traiter</label>
                <textarea id="ids" rows="8" class="form-textarea" placeholder="Exemple:\n123456789\n987654321\n1122334455"></textarea>
                <div id="ids-count" class="field-info">0 ID d√©tect√©</div>
            </div>

            <div class="button-group-sm">
                <button type="button" id="btn-clear" class="btn-sm btn-danger" onclick="clearIDs()">
                    <span id="btn-clear-text">üóëÔ∏è Vider</span>
                </button>
            </div>

            <!-- Options avanc√©es (repliable) -->
            <details class="advanced-options">
                <summary class="advanced-options-summary" id="advanced-summary">‚öôÔ∏è Options avanc√©es (capture automatique)</summary>
                <div class="advanced-options-content">
                    <p class="text-xs text-slate-600 dark:text-slate-400 mb-3" id="advanced-hint">
                        Ces options permettent d'ajouter automatiquement des IDs copi√©s dans votre presse-papiers
                    </p>
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <button type="button" id="clip-toggle" class="btn-sm btn-secondary flex-1">
                                <span id="clip-toggle-text">üìã Capture presse-papiers</span>
                            </button>
                            <span id="clip-status" class="status-badge">Inactif</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" id="paste-toggle" class="btn-sm btn-secondary flex-1">
                                <span id="paste-toggle-text">üìé Mode collage</span>
                            </button>
                            <span id="paste-status" class="status-badge">Off</span>
                        </div>
                    </div>
                </div>
            </details>

            <!-- SECTION 3: Code cadeau -->
            <div class="section-divider"></div>
            <div class="form-group">
                <div class="section-header-inline">
                    <div class="section-number-sm">3</div>
                    <label for="giftcode" id="label-giftcode" class="form-label-inline">Code cadeau √† appliquer</label>
                </div>
                <input type="text" id="giftcode" class="form-input" placeholder="Entrez le code cadeau ici...">
                <p class="field-info" id="giftcode-hint">Le code sera appliqu√© √† tous les IDs de la liste</p>
            </div>

            <!-- SECTION 4: Lancement -->
            <div class="section-divider"></div>
            <button type="submit" id="submit-btn" class="btn btn-primary btn-large">
                <span class="text-lg">üöÄ</span>
                <span id="btn-text">Lancer l'application du code</span>
            </button>
        </form>
    </div>

    <!-- SECTION 5: R√©sultats -->
    <div class="section-card" id="results-section">
        <div class="section-header">
            <div class="section-number">4</div>
            <div>
                <h2 class="section-title" id="section-results-title">R√©sultats</h2>
                <p class="section-hint" id="section-results-hint">Suivi en temps r√©el de l'application du code</p>
            </div>
        </div>
        <div class="message" id="message"></div>
    </div>
</div>

<script>
// Reprend la m√©thode appendSign de l'app d'origine
function appendSign(params) {
    const base = Object.keys(params)
        .sort()
        .reduce((acc, key) => {
            const val = typeof params[key] === 'object' ? JSON.stringify(params[key]) : params[key];
            return acc + (acc ? '&' : '') + key + '=' + val;
        }, '');
    const sign = CryptoJS.MD5(base + 'mN4!pQs6JrYwV9').toString(CryptoJS.enc.Hex);
    return { ...params, sign };
}

// Helper pour POST x-www-form-urlencoded
async function apiPost(path, payload) {
    const url = `https://kingshot-giftcode.centurygame.com/api${path}`;
    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(payload).toString()
    });
    const json = await res.json().catch(() => ({}));
    return { res, json };
}

// Attente utilitaire
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// POST avec retry en cas de 429/erreurs transitoires. Le payload est sign√© √† chaque tentative.
async function postWithRetry(path, basePayload, options = {}) {
    const { retries = 3, baseDelay = 900, jitter = 250 } = options;
    let attempt = 0;
    while (true) {
        try {
            // Re-signer √† chaque tentative avec un timestamp frais
            const payload = appendSign({ ...basePayload, time: Date.now() });
            const { res, json } = await apiPost(path, payload);
            if (res && res.status === 429) {
                if (attempt >= retries) return { res, json };
                // Politique demand√©e: attendre 11 secondes fixes avant retry en cas de 429
                await sleep(11000);
                attempt++;
                continue;
            }
            // Si pas 429, retourner tel quel
            return { res, json };
        } catch (err) {
            if (attempt >= retries) throw err;
            const wait = baseDelay * Math.pow(2, attempt) + Math.floor(Math.random() * jitter);
            await sleep(wait);
            attempt++;
        }
    }
}

// Helpers
const idsTextarea = document.getElementById('ids');
const idsCount = document.getElementById('ids-count');
const submitBtn = document.getElementById('submit-btn');
const btnText = document.getElementById('btn-text');
const themeToggle = document.getElementById('theme-toggle');
const themeIcon = document.getElementById('theme-icon');
const themeLabel = document.getElementById('theme-label');
const appTitle = document.getElementById('app-title');
const subtitle = document.getElementById('subtitle');
const labelIds = document.getElementById('label-ids');
const labelGift = document.getElementById('label-giftcode');
const clipToggleBtn = document.getElementById('clip-toggle');
const clipStatus = document.getElementById('clip-status');
const pasteToggleBtn = document.getElementById('paste-toggle');
const pasteStatus = document.getElementById('paste-status');
const listSelect = document.getElementById('list-select');
const listNewBtn = document.getElementById('list-new');
const listRenameBtn = document.getElementById('list-rename');
const listDeleteBtn = document.getElementById('list-delete');
const listSaveBtn = document.getElementById('list-save');
const listLoadBtn = document.getElementById('list-load');
const listInfosBtn = document.getElementById('list-infos');
const listStatus = document.getElementById('list-status');
const listInfosView = document.getElementById('list-infos-view');
const infosDiv = document.getElementById('infos');

function parseIDs(text) {
    // Split on newlines, commas, or semicolons; trim, filter empty; deduplicate
    const parts = text.split(/[\n\r,;]+/).map(s => s.trim()).filter(Boolean);
    return Array.from(new Set(parts));
}

function updateIdsCount() {
    const count = parseIDs(idsTextarea.value).length;
    const L = window.__i18nLang || 'fr';
    idsCount.textContent = L === 'en'
        ? `${count} ${count > 1 ? 'IDs detected' : 'ID detected'}`
        : `${count} ${count > 1 ? 'IDs d√©tect√©s' : 'ID d√©tect√©'}`;
}

idsTextarea.addEventListener('input', updateIdsCount);

// Capture auto du presse-papiers
const clipboard = { enabled: false, timer: null, last: '', intervalMs: 800, focusBoostTimer: null };

function extractIdsFromText(text) {
    // Utilise le parseur existant puis filtre vers des IDs num√©riques raisonnables (6-15 chiffres)
    const tokens = parseIDs(text);
    return tokens.filter(t => /^[0-9]{6,15}$/.test(t));
}

async function readClipboardOnce() {
    try {
        // Essaye d‚Äôobtenir la permission si support√©e
        try { if (navigator.permissions?.query) { await navigator.permissions.query({ name: 'clipboard-read' }); } } catch {}
        const text = await navigator.clipboard.readText();
        return text || '';
    } catch {
        return '';
    }
}

// Sonde le presse‚Äëpapiers p√©riodiquement et ajoute les nouveaux IDs d√©tect√©s
async function pollClipboard() {
    if (!clipboard.enabled) return;
    const text = await readClipboardOnce();
    if (text && text !== clipboard.last) {
        clipboard.last = text;
        const newIds = extractIdsFromText(text);
        if (newIds.length) {
            const existing = new Set(parseIDs(idsTextarea.value));
            const uniques = newIds.filter(id => !existing.has(id));
            if (uniques.length) {
                const prefix = idsTextarea.value.trim().length ? '\n' : '';
                idsTextarea.value += prefix + uniques.join('\n');
                updateIdsCount();
                // Petit retour visuel discret
                clipStatus.textContent = `Captur√© ${uniques.length} nouveau${uniques.length>1?'x':''}`;
                setTimeout(() => { if (clipboard.enabled) clipStatus.textContent = 'Actif'; }, 1500);
            }
        }
    }
}

function startClipboardCapture() {
    clipboard.enabled = true;
    const L = window.__i18nLang || 'fr';
    const clipToggleText = document.getElementById('clip-toggle-text');
    if (clipToggleText) clipToggleText.textContent = L === 'en' ? 'üìã Disable clipboard' : 'üìã D√©sactiver presse-papiers';
    clipStatus.textContent = L === 'en' ? 'Active' : 'Actif';
    setClipboardInterval(clipboard.intervalMs);
    // Gestion de visibilit√©/focus
    window.addEventListener('visibilitychange', onVisibilityChange);
    window.addEventListener('focus', onFocusGain);
    window.addEventListener('blur', onFocusLoss);
}

function stopClipboardCapture() {
    clipboard.enabled = false;
    const L = window.__i18nLang || 'fr';
    const clipToggleText = document.getElementById('clip-toggle-text');
    if (clipToggleText) clipToggleText.textContent = L === 'en' ? 'üìã Enable clipboard' : 'üìã Activer presse-papiers';
    clipStatus.textContent = L === 'en' ? 'Inactive' : 'Inactif';
    if (clipboard.timer) { clearInterval(clipboard.timer); clipboard.timer = null; }
    if (clipboard.focusBoostTimer) { clearTimeout(clipboard.focusBoostTimer); clipboard.focusBoostTimer = null; }
    window.removeEventListener('visibilitychange', onVisibilityChange);
    window.removeEventListener('focus', onFocusGain);
    window.removeEventListener('blur', onFocusLoss);
}

clipToggleBtn.addEventListener('click', async () => {
    if (clipboard.enabled) { stopClipboardCapture(); return; }
    // Tentative de lecture imm√©diate (d√©clench√©e par interaction utilisateur)
    const txt = await readClipboardOnce();
    if (!txt) {
        const L = window.__i18nLang || 'fr';
        clipStatus.textContent = L === 'en' ? 'Permission denied or empty' : 'Permission refus√©e ou vide';
        setTimeout(() => { if (!clipboard.enabled) clipStatus.textContent = (L === 'en' ? 'Inactive' : 'Inactif'); }, 1500);
        // On continue quand m√™me: l‚Äôutilisateur recopiera et le navigateur pourra donner l‚Äôacc√®s apr√®s
    }
    startClipboardCapture();
});

function setClipboardInterval(ms) {
    if (clipboard.timer) clearInterval(clipboard.timer);
    clipboard.timer = setInterval(pollClipboard, ms);
}

function onVisibilityChange() {
    if (!clipboard.enabled) return;
    if (document.hidden) {
        // Onglet en arri√®re-plan: r√©duire la fr√©quence pour limiter le throttling
        setClipboardInterval(15000);
    } else {
        // De retour au premier plan: lecture imm√©diate + boost temporaire
        boostOnFocus();
    }
}

function onFocusGain() {
    if (!clipboard.enabled) return;
    boostOnFocus();
}

function onFocusLoss() {
    if (!clipboard.enabled) return;
    // En perte de focus, mettre un interval plus long
    setClipboardInterval(15000);
}

function boostOnFocus() {
    // Lecture imm√©diate
    pollClipboard();
    // Interval rapide pendant 3s pour capter des copies en rafale au retour
    setClipboardInterval(400);
    if (clipboard.focusBoostTimer) clearTimeout(clipboard.focusBoostTimer);
    clipboard.focusBoostTimer = setTimeout(() => {
        if (!clipboard.enabled) return;
        setClipboardInterval(clipboard.intervalMs);
        clipboard.focusBoostTimer = null;
    }, 3000);
}

// Mode collage (sans permission): utilise l‚Äô√©v√©nement paste, aucune autorisation n√©cessaire
const pasteCapture = { enabled: false };
function onPaste(e) {
    const text = (e && e.clipboardData && e.clipboardData.getData('text')) || '';
    if (!text) return;
    const newIds = extractIdsFromText(text);
    if (!newIds.length) return;
    const existing = new Set(parseIDs(idsTextarea.value));
    const uniques = newIds.filter(id => !existing.has(id));
    if (!uniques.length) return;
    const prefix = idsTextarea.value.trim().length ? '\n' : '';
    idsTextarea.value += prefix + uniques.join('\n');
    updateIdsCount();
    const L = window.__i18nLang || 'fr';
    pasteStatus.textContent = L === 'en' ? `Added ${uniques.length}` : `Ajout√© ${uniques.length}`;
    setTimeout(() => { if (pasteCapture.enabled) pasteStatus.textContent = (L === 'en' ? 'On' : 'On'); }, 1200);
}

function startPasteCapture() {
    if (pasteCapture.enabled) return;
    pasteCapture.enabled = true;
    window.addEventListener('paste', onPaste);
    const L = window.__i18nLang || 'fr';
    const pasteToggleText = document.getElementById('paste-toggle-text');
    if (pasteToggleText) pasteToggleText.textContent = L === 'en' ? 'üìé Disable paste mode' : 'üìé D√©sactiver collage';
    pasteStatus.textContent = L === 'en' ? 'On' : 'On';
}

function stopPasteCapture() {
    if (!pasteCapture.enabled) return;
    pasteCapture.enabled = false;
    window.removeEventListener('paste', onPaste);
    const L = window.__i18nLang || 'fr';
    const pasteToggleText = document.getElementById('paste-toggle-text');
    if (pasteToggleText) pasteToggleText.textContent = L === 'en' ? 'üìé Paste mode' : 'üìé Mode collage';
    pasteStatus.textContent = L === 'en' ? 'Off' : 'Off';
}

pasteToggleBtn.addEventListener('click', () => {
    if (pasteCapture.enabled) stopPasteCapture(); else startPasteCapture();
});

// Sauvegarder les IDs dans le localStorage
function saveIDs() { saveCurrentListFromField(); }

function loadIDs() { loadCurrentListToField(); }

function clearIDs() {
    idsTextarea.value = '';
    updateIdsCount();
}

function setSubmitting(isSubmitting) {
    submitBtn.disabled = isSubmitting;
    const L = window.__i18nLang || 'fr';
    btnText.textContent = isSubmitting
        ? (L === 'en' ? 'Processing‚Ä¶' : 'Traitement en cours‚Ä¶')
        : (L === 'en' ? 'Launch code application' : 'Lancer l\'application du code');
}

// Th√®me (clair/sombre)
function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    if (themeIcon) themeIcon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}

function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'light' || saved === 'dark') {
        applyTheme(saved);
    } else {
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        applyTheme(prefersLight ? 'light' : 'dark');
    }
}

themeToggle?.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    applyTheme(cur === 'dark' ? 'light' : 'dark');
});

// Auto-charger les IDs sauvegard√©s au d√©marrage + th√®me
window.addEventListener('DOMContentLoaded', () => {
    initTheme();
    initI18n();
    initLists();
    loadCurrentListToField();
});
// ===== i18n simple FR/EN =====
function detectLang() {
    const nav = (navigator.language || navigator.userLanguage || 'fr').toLowerCase();
    return nav.startsWith('en') ? 'en' : 'fr';
}

function initI18n() {
    window.__i18nLang = detectLang();
    applyI18n();
}

function applyI18n() {
    const L = 'en' || window.__i18nLang || 'fr';
    
    // En-t√™te
    if (appTitle) appTitle.textContent = L === 'en' ? 'Gift code tool' : 'Codes cadeaux';
    if (subtitle) subtitle.textContent = L === 'en'
        ? 'Paste your IDs (one per line) and redeem a gift code on the fly.'
        : 'Collez vos IDs (un par ligne) et appliquez un code cadeau √† la vol√©e.';
    if (themeLabel) themeLabel.textContent = L === 'en' ? 'Theme' : 'Th√®me';

    // Section 1: Listes
    const sectionListsTitle = document.getElementById('section-lists-title');
    const sectionListsHint = document.getElementById('section-lists-hint');
    if (sectionListsTitle) sectionListsTitle.textContent = L === 'en' ? 'My ID lists' : 'Mes listes d\'IDs';
    if (sectionListsHint) sectionListsHint.textContent = L === 'en' 
        ? 'Create and manage your ID lists for easy reuse'
        : 'Cr√©ez et g√©rez vos listes d\'IDs pour les r√©utiliser facilement';

    const listsLabel = document.getElementById('lists-label');
    if (listsLabel) listsLabel.textContent = L === 'en' ? 'Active list' : 'Liste active';

    const btnListLoad = document.getElementById('btn-list-load-text');
    const btnListSave = document.getElementById('btn-list-save-text');
    const btnListNew = document.getElementById('btn-list-new-text');
    const btnListRename = document.getElementById('btn-list-rename-text');
    const btnListDelete = document.getElementById('btn-list-delete-text');
    const btnListInfos = document.getElementById('btn-list-infos-text');
    
    if (btnListLoad) btnListLoad.textContent = L === 'en' ? 'Load to field' : 'Charger dans le champ';
    if (btnListSave) btnListSave.textContent = L === 'en' ? 'Save field' : 'Sauvegarder le champ';
    if (btnListNew) btnListNew.textContent = L === 'en' ? '+ New' : '+ Nouvelle';
    if (btnListRename) btnListRename.textContent = L === 'en' ? '‚úèÔ∏è Rename' : '‚úèÔ∏è Renommer';
    if (btnListDelete) btnListDelete.textContent = L === 'en' ? 'üóëÔ∏è Delete' : 'üóëÔ∏è Supprimer';
    if (btnListInfos) btnListInfos.textContent = L === 'en' ? '‚ÑπÔ∏è Player infos' : '‚ÑπÔ∏è Infos joueurs';

    const labelInfosTitle = document.getElementById('label-infos-title');
    if (labelInfosTitle) labelInfosTitle.textContent = L === 'en' ? 'User infos' : 'Infos utilisateurs';

    // Section 2: IDs
    const sectionIdsTitle = document.getElementById('section-ids-title');
    const sectionIdsHint = document.getElementById('section-ids-hint');
    if (sectionIdsTitle) sectionIdsTitle.textContent = L === 'en' ? 'Player IDs list' : 'Liste des IDs joueurs';
    if (sectionIdsHint) sectionIdsHint.textContent = L === 'en'
        ? 'Paste IDs (one per line, or separated by commas)'
        : 'Collez les IDs (un par ligne, ou s√©par√©s par des virgules)';

    if (labelIds) labelIds.textContent = L === 'en' ? 'IDs to process' : 'IDs √† traiter';
    const btnClearText = document.getElementById('btn-clear-text');
    if (btnClearText) btnClearText.textContent = L === 'en' ? 'üóëÔ∏è Clear' : 'üóëÔ∏è Vider';

    // Options avanc√©es
    const advancedSummary = document.getElementById('advanced-summary');
    const advancedHint = document.getElementById('advanced-hint');
    if (advancedSummary) advancedSummary.textContent = L === 'en' 
        ? '‚öôÔ∏è Advanced options (auto-capture)'
        : '‚öôÔ∏è Options avanc√©es (capture automatique)';
    if (advancedHint) advancedHint.textContent = L === 'en'
        ? 'These options allow automatic addition of IDs copied to your clipboard'
        : 'Ces options permettent d\'ajouter automatiquement des IDs copi√©s dans votre presse-papiers';

    const clipToggleText = document.getElementById('clip-toggle-text');
    const pasteToggleText = document.getElementById('paste-toggle-text');
    if (clipToggleText) clipToggleText.textContent = clipboard.enabled
        ? (L === 'en' ? 'üìã Disable clipboard' : 'üìã D√©sactiver presse-papiers')
        : (L === 'en' ? 'üìã Enable clipboard' : 'üìã Activer presse-papiers');
    if (pasteToggleText) pasteToggleText.textContent = pasteCapture.enabled
        ? (L === 'en' ? 'üìé Disable paste mode' : 'üìé D√©sactiver collage')
        : (L === 'en' ? 'üìé Paste mode' : 'üìé Mode collage');

    if (clipStatus) clipStatus.textContent = clipboard.enabled
        ? (L === 'en' ? 'Active' : 'Actif')
        : (L === 'en' ? 'Inactive' : 'Inactif');
    if (pasteStatus) pasteStatus.textContent = pasteCapture.enabled 
        ? (L === 'en' ? 'On' : 'On') 
        : (L === 'en' ? 'Off' : 'Off');

    // Section 3: Code cadeau
    if (labelGift) labelGift.textContent = L === 'en' ? 'Gift code to apply' : 'Code cadeau √† appliquer';
    const giftInput = document.getElementById('giftcode');
    if (giftInput) giftInput.placeholder = L === 'en' ? 'Enter the gift code here...' : 'Entrez le code cadeau ici...';
    const giftcodeHint = document.getElementById('giftcode-hint');
    if (giftcodeHint) giftcodeHint.textContent = L === 'en'
        ? 'The code will be applied to all IDs in the list'
        : 'Le code sera appliqu√© √† tous les IDs de la liste';

    // Section 4: Bouton submit
    const sectionResultsTitle = document.getElementById('section-results-title');
    const sectionResultsHint = document.getElementById('section-results-hint');
    if (sectionResultsTitle) sectionResultsTitle.textContent = L === 'en' ? 'Results' : 'R√©sultats';
    if (sectionResultsHint) sectionResultsHint.textContent = L === 'en'
        ? 'Real-time tracking of code application'
        : 'Suivi en temps r√©el de l\'application du code';

    // Bouton submit et compteur
    setSubmitting(false);
    updateIdsCount();
}

// Soumettre les IDs √† l'API
document.getElementById('giftcode-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const messageDiv = document.getElementById('message');
    messageDiv.innerHTML = '';

    const ids = parseIDs(idsTextarea.value);
    const giftcode = document.getElementById('giftcode').value.trim();

    if (!giftcode) {
        messageDiv.innerHTML = '<div class="status-error">Veuillez entrer un code cadeau.</div>';
        return;
    }
    if (ids.length === 0) {
        messageDiv.innerHTML = '<div class="status-error">Aucun ID valide d√©tect√© (utilisez des virgules ou des retours √† la ligne).</div>';
        return;
    }

    setSubmitting(true);
    messageDiv.innerHTML = `<span class="inline-block text-xs px-2 py-1 rounded-full border border-sky-300 bg-sky-50 text-sky-700 dark:border-sky-700 dark:bg-sky-900/30 dark:text-sky-300">Traitement s√©quentiel de ${ids.length} ID${ids.length>1?'s':''}</span>`;

    let success = 0, failed = 0, already = 0, invalid = 0;
    let abortAll = false; // arr√™t global si code invalide/erron√©
    let abortLabel = '';
    const linesArr = [];

    function renderProgress() {
        const lines = linesArr.join('');
        messageDiv.innerHTML = `
            <div class="flex gap-2 items-center flex-wrap">
                <span class="inline-block text-xs px-2 py-0.5 rounded-full border border-emerald-300 bg-emerald-50 text-emerald-700 dark:border-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">${success} succ√®s</span>
                <span class="inline-block text-xs px-2 py-0.5 rounded-full border border-amber-300 bg-amber-50 text-amber-700 dark:border-amber-700 dark:bg-amber-900/30 dark:text-amber-300">${already} d√©j√† re√ßu</span>
                <span class="inline-block text-xs px-2 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-slate-700 dark:border-slate-700 dark:bg-slate-800/40 dark:text-slate-300">${invalid} code invalide</span>
                <span class="inline-block text-xs px-2 py-0.5 rounded-full border border-red-300 bg-red-50 text-red-700 dark:border-red-700 dark:bg-red-900/30 dark:text-red-300">${failed} √©chec${failed>1?'s':''}</span>
                ${abortAll ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded-full border border-red-300 bg-red-50 text-red-700 dark:border-red-700 dark:bg-red-900/30 dark:text-red-300\">Arr√™t: ${abortLabel}</span>` : ''}
            </div>
            <div class="mt-2 grid gap-1.5">${lines}</div>
        `;
    }

    for (const id of ids) {
        // 1) Connexion utilisateur (s√©quentiel + retry 429)
        let connectOk = false, connectJson = null, connectErr = null;
        try {
            // Attendre 1s avant le login pour √©viter des bugs c√¥t√© serveur
            await sleep(1000);
            const { res, json } = await postWithRetry('/player', { fid: id }, { retries: 4, baseDelay: 1000, jitter: 300 });
            connectJson = json;
            connectOk = !!(json && (json.success === true || json.code === 0));
            // Si on re√ßoit un 429 mais pas d'erreur throw, consid√©rer comme √©chec et continuer (la boucle de retry aura d√©j√† tent√©)
            if (res && res.status === 429 && !connectOk) {
                connectErr = new Error('429 Too Many Requests');
            }
        } catch (e) {
            connectErr = e;
        }

        if (!connectOk) {
            failed++;
            const connectMsg = (connectJson && (connectJson.message || connectJson.msg)) || (connectErr && connectErr.message) || '';
            const connectPill = `<span class="inline-block text-[10px] px-1.5 py-0.5 rounded-full border border-red-300 bg-red-50 text-red-700 dark:border-red-700 dark:bg-red-900/30 dark:text-red-300">Connexion</span>`;
            linesArr.push(`<div class="text-sm">${connectPill} ‚Äî ID ${id}${connectMsg ? ` ¬∑ ${connectMsg}` : ''}</div>`);
            renderProgress();
            // petit d√©lai entre IDs pour √©viter burst
            await sleep(300);
            continue;
        }

        // 2) Redeem code (s√©quentiel + retry 429)
        let redeemOk = false, redeemJson = null, redeemErr = null, status = 'fail';
        try {
            // Attendre 1s avant le redeem pour √©viter des bugs c√¥t√© serveur
            await sleep(1000);
            const { res, json } = await postWithRetry('/gift_code', { fid: id, cdk: giftcode, captcha_code: '' }, { retries: 3, baseDelay: 1200, jitter: 350 });
            redeemJson = json;
            const msg = (json && typeof json.msg === 'string') ? json.msg.toUpperCase() : '';
            redeemOk = !!(json && (Number(json.code) === 0 || Number(json.err_code) === 20000));
            const alreadyReceived = !!(json && (json.err_code === 40008 || msg.includes('RECEIVED')));
            const isInvalid = !!(json && (json.err_code === 40005 || json.err_code === 40014 || msg.includes('USED') || msg.includes('CDK NOT FOUND')));
            if (redeemOk) { status = 'success'; success++; }
            else if (alreadyReceived) { status = 'already'; already++; }
            else if (isInvalid) { status = 'invalid'; invalid++; }
            else { status = 'fail'; failed++; }
            if (res && res.status === 429 && !redeemOk) {
                redeemErr = new Error('429 Too Many Requests');
            }
        } catch (e) {
            redeemErr = e; failed++; status = 'fail';
        }

        const connectPill = `<span class=\"inline-block text-[10px] px-1.5 py-0.5 rounded-full border border-emerald-300 bg-emerald-50 text-emerald-700 dark:border-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300\">Connexion</span>`;
        let redeemPill = `<span class="inline-block text-[10px] px-1.5 py-0.5 rounded-full border border-red-300 bg-red-50 text-red-700 dark:border-red-700 dark:bg-red-900/30 dark:text-red-300">Redeem</span>`;
        if (status === 'success') redeemPill = `<span class="inline-block text-[10px] px-1.5 py-0.5 rounded-full border border-emerald-300 bg-emerald-50 text-emerald-700 dark:border-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">Redeem</span>`;
        if (status === 'already') redeemPill = `<span class="inline-block text-[10px] px-1.5 py-0.5 rounded-full border border-amber-300 bg-amber-50 text-amber-700 dark:border-amber-700 dark:bg-amber-900/30 dark:text-amber-300">D√©j√† re√ßu</span>`;
        if (status === 'invalid') redeemPill = `<span class="inline-block text-[10px] px-1.5 py-0.5 rounded-full border border-slate-300 bg-slate-50 text-slate-700 dark:border-slate-700 dark:bg-slate-800/40 dark:text-slate-300">Code invalide</span>`;
        const redeemMsg = (redeemJson && (redeemJson.message || redeemJson.msg)) || (redeemErr && redeemErr.message) || '';
        linesArr.push(`<div class="text-sm">${connectPill} ${redeemPill} ‚Äî ID ${id}${redeemMsg ? ` ¬∑ ${redeemMsg}` : ''}</div>`);
        renderProgress();

        // Arr√™t global si le code est invalide/erron√©
        if (status === 'invalid') {
            abortAll = true;
            abortLabel = redeemMsg || 'code invalide/erron√©';
            break;
        }

        // d√©lai l√©ger pour √©viter rate limit
        await sleep(300);
    }

    setSubmitting(false);
});

// ===== Gestion des listes =====
function uuid() { return 'list-' + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

function getLists() {
    const json = localStorage.getItem('id_lists');
    try { return json ? JSON.parse(json) : []; } catch { return []; }
}
function saveLists(lists) { localStorage.setItem('id_lists', JSON.stringify(lists)); }
function getActiveListId() { return localStorage.getItem('active_list_id'); }
function setActiveListId(id) { localStorage.setItem('active_list_id', id); }

function ensureDefaultList() {
    let lists = getLists();
    // Supprimer d'√©ventuelles anciennes listes par d√©faut ind√©sirables
    lists = lists.filter(l => l.name !== 'Alliance FARM' && l.name !== 'APX Alliance');

    // Ajouter BR2 Alliance si elle n'existe pas
    const hasBR2 = lists.some(l => l.name === 'BR2 Alliance');
    if (!hasBR2) {
        const br2Ids = [
            '102607890','101182366','101166063','104213539','104327984','102771274','103836911','101640947','101100162','103836599',
            '102345777','104639538','103017284','102690013','103967266','100821859','104541023','101870754','103295707','103410904',
            '101428169','101083840','102542520','102575120','103213892','101771916','103000964','104541004','101330001','101493879',
            '101510056','104328049','101755383','102313155','104082381','103083165','101624284','101100275','115999874','103459721',
            '125089079','102492840','103181497','102247155','102509365','101723240','102755036','100821714','104671988','103721717',
            '103623826','103263067','104672337','101345952','101903195','102722413','104000182','102361881','104360503','102558442',
            '102591357','102738620','104639562','102181489','100772475','103639597','102083218','102575066','104016742','103590565',
            '102099828','101559049','103279817','104737239','100674407','128270597','101116712','104770664','100903577','103328368',
            '103525343','102657245','103640178','104180488','102607788','101394910','166699973','102608003'
        ];
        const br2 = { id: uuid(), name: 'BR2 Alliance', ids: br2Ids, info: {} };
        // Mettre BR2 en premi√®re position
        lists.unshift(br2);
        saveLists(lists);
        // Activer BR2 par d√©faut
        setActiveListId(br2.id);
    } else {
        // Si BR2 existe d√©j√†, s'assurer qu'elle est active si l'actif courant a √©t√© supprim√©
        const activeId = getActiveListId();
        const stillHasActive = lists.some(l => l.id === activeId);
        if (!stillHasActive) {
            const br2 = lists.find(l => l.name === 'BR2 Alliance');
            if (br2) setActiveListId(br2.id);
        }
        saveLists(lists);
    }
}

function initLists() {
    ensureDefaultList();
    refreshListsUI();
}

function refreshListsUI() {
    const lists = getLists();
    const activeId = getActiveListId() || (lists[0] && lists[0].id);
    listSelect.innerHTML = '';
    lists.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id; opt.textContent = `${l.name} (${l.ids.length})`;
        if (l.id === activeId) opt.selected = true;
        listSelect.appendChild(opt);
    });
    if (activeId) setActiveListId(activeId);
}

function currentList() {
    const id = listSelect.value || getActiveListId();
    const lists = getLists();
    return lists.find(l => l.id === id);
}

function updateList(updated) {
    const lists = getLists();
    const idx = lists.findIndex(l => l.id === updated.id);
    if (idx >= 0) { lists[idx] = updated; saveLists(lists); refreshListsUI(); }
}

listSelect.addEventListener('change', () => {
    setActiveListId(listSelect.value);
});

listNewBtn.addEventListener('click', () => {
    const name = prompt('Nom de la nouvelle liste ?', 'Nouvelle liste');
    if (!name) return;
    const lists = getLists();
    const l = { id: uuid(), name, ids: [], info: {} };
    lists.push(l); saveLists(lists); setActiveListId(l.id); refreshListsUI();
});

listRenameBtn.addEventListener('click', () => {
    const l = currentList(); if (!l) return;
    const name = prompt('Nouveau nom de la liste :', l.name);
    if (!name) return;
    l.name = name; updateList(l);
});

listDeleteBtn.addEventListener('click', () => {
    const l = currentList(); if (!l) return;
    if (!confirm(`Supprimer la liste "${l.name}" ?`)) return;
    let lists = getLists();
    lists = lists.filter(x => x.id !== l.id);
    saveLists(lists);
    if (lists.length) setActiveListId(lists[0].id); else localStorage.removeItem('active_list_id');
    ensureDefaultList(); refreshListsUI();
});

function saveCurrentListFromField() {
    const l = currentList(); if (!l) return;
    const ids = parseIDs(idsTextarea.value);
    l.ids = ids; l.info = l.info || {};
    updateList(l);
    listStatus.textContent = `Sauvegard√© (${ids.length} IDs)`;
    setTimeout(() => { listStatus.textContent = ''; }, 1500);
}

function loadCurrentListToField() {
    const l = currentList(); if (!l) return;
    idsTextarea.value = (l.ids || []).join('\n');
    updateIdsCount();
    listStatus.textContent = `Charg√© (${l.ids.length} IDs)`;
    setTimeout(() => { listStatus.textContent = ''; }, 1500);
}

listSaveBtn.addEventListener('click', saveCurrentListFromField);
listLoadBtn.addEventListener('click', loadCurrentListToField);

// R√©cup√©ration des infos via /player et affichage
listInfosBtn.addEventListener('click', async () => {
    const l = currentList(); if (!l) return;
    const ids = parseIDs(idsTextarea.value);
    if (!ids.length) { listStatus.textContent = 'Aucun ID'; setTimeout(() => listStatus.textContent = '', 1200); return; }
    listStatus.textContent = `R√©cup√©ration 0/${ids.length}‚Ä¶`;

    // S√©quentiel avec cooldown et retry 429
    const items = [];
    l.info = l.info || {};
    let i = 0;
    for (const fid of ids) {
        try {
            // Cooldown d'1s avant chaque requ√™te /player
            await sleep(1000);
            const { json } = await postWithRetry('/player', { fid }, { retries: 4, baseDelay: 1000, jitter: 300 });
            if (json && (json.success === true || json.code === 0) && json.data) {
                l.info[fid] = json.data;
                items.push({ fid, ok: true, data: json.data });
            }
        } catch {}
        i++;
        listStatus.textContent = `R√©cup√©ration ${i}/${ids.length}‚Ä¶`;
    }
    updateList(l);

    if (items.length) {
        listInfosView.classList.remove('hidden');
        infosDiv.innerHTML = items.map(({ fid, data }) => {
            const img = data.avatar_image || '';
            return `
            <div class="flex items-center gap-3 p-2 rounded-lg border border-slate-200 dark:border-slate-800">
              <img src="${img}" alt="avatar" class="w-8 h-8 rounded-full object-cover" onerror="this.style.display='none'" />
              <div class="flex-1 text-sm text-slate-800 dark:text-slate-200">
                <div class="font-semibold">${data.nickname || '‚Äî'} <span class="text-xs text-slate-500">(ID ${fid})</span></div>
                <div class="text-xs text-slate-600 dark:text-slate-400">Serveur: ${data.kid ?? '‚Äî'} ¬∑ Niveau po√™le: ${data.stove_lv ?? '‚Äî'} ¬∑ Recharges: ${data.total_recharge_amount ?? '‚Äî'}</div>
              </div>
            </div>`;
        }).join('');
    } else {
        infosDiv.innerHTML = '<div class="text-xs text-slate-500">Aucune info r√©cup√©r√©e.</div>';
        listInfosView.classList.remove('hidden');
    }

    listStatus.textContent = `Infos mises √† jour (${items.length}/${ids.length})`;
    setTimeout(() => { listStatus.textContent = ''; }, 1500);
});
</script>

</body>
</html>
